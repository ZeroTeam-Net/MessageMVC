﻿# 系统功能通过redis实现高可用消息队列### 保证发送可靠性1 消费前永久保存消息2 发送失败重试3 失败发送，本地文件保存，重启后重试发送> 保存目录为 {app root}\datas\redis。app root是您的应用程序根目录。默认：开发模式，与部署目录相同；生产模式，在部署目录上一层### 保证一次成功消费1 双队列保证未成功消费的ID不丢失2 消费完成后删除备份队列ID3 消费成功删除信息内容4 消费失败按配置选择加入失败队列4 消费异常记录异常队列5 重启后异常队列/失败队列重新入队﻿﻿﻿# 配置appsettings.json```json{    "Redis": {    "ConnectionString": "47.98.229.139",    "GuardCheckTime": 3000,    "MessageLockTime": 3000,    "FailedIsError": false,    "NoSupperIsError": false  }}```| 配置项 | 默认值 | 说明 || :---------------- | --------------: | :------------------- || ConnectionString | <空>  | 连接字符串,必须配置 || GuardCheckTime| 3000  | 异常守卫多久检查一次,单位ms|| MessageLockTime | 1000  | 消息处理过程锁定时长,单位ms|| FailedIsError| false| 消息处理失败按发生异常处理|| NoSupperIsError| false| 无处理方法按发生异常处理|### ConnectionString > 127.0.0.1:6379,password=123,defaultDatabase=13;**为提高可维护性,应该分配一个独立的db.**| 参数名 | 默认值 | 说明 || :---------------- | --------------: | :------------------- || password          | <空>  | 密码 || defaultDatabase   | 0     | 默认数据库 || poolsize          | 50    | 连接池大小 || connectTimeout    | 5000  | 连接超时设置(毫秒) || syncTimeout       | 10000 | 发送/接收超时设置(毫秒) || idleTimeout       | 20000 | 连接池内元素空闲时间(毫秒)，适用连接远程redis-server || preheat           | true  | 预热连接，接收数值如 preheat=5 预热5个连接 || autoDispose       | true  | 跟随系统退出事件自动释放 || ssl               | false | 是否开启加密传输 || testcluster       | true  | 是否尝试集群模式，阿里云、腾讯云集群需要设置此选项为 false || writeBuffer       | 10240 | 异步方法写入缓冲区大小(字节) || tryit             | 0     | 执行命令出错，尝试重试的次数 || name              | <空>  | 连接名称，可以使用 Client List 命令查看 || prefix            | <空>  | key前辍，所有方法都会附带此前辍，csredis.Set(prefix + "key", 111); |更多请参考 : [CsRedis](https://github.com/2881099/csredis/master/README.md)# 数据# Redis 数据> 参数中channel为主题,id为消息的UUID标识| 类型 | 作用 | 命名 || :----------------:| :------------------- | :-------------- || 消息主体 |存储消息内容| msg:{channel}:{id} || 消息锁   |防止消息被并发重复处理| guard:{channel}:{id} || 主队列|消费者处理的队列,仅存储消息ID| msg:{channel} || 备份队列|防止处理异常中断,如服务异常关闭| bak:{channel} | | 错误队列| 防止未处理异常而导致的非正常消息丢失|fai:{channel}|# Flags### 灾难性后果消息发送时Redis不可写入且本地文件无法写入,将会带来无法恢复的后果,如果要防止此事故发生，请在重启服务前恢复磁盘空间或以其它方式保证文件写入正常。如在此时关闭服务，后果未知。### BUG处理当消费服务发生异常时，会记录到错误队列中，每次重启服务将会对此异常重新入列处理（我们假设你修复了BUG）。但这只是一个美丽的想法，如果您并未去查看错误日志并修复BUG，此处理并无用。当然，特殊情况，需要你手工处理这些数据。> 养成查看系统错误日志是一个严谨的工作态度和习惯，我建议甚至要求你必须这么做。